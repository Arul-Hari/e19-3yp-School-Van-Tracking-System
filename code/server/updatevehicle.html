<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update Vehicle Details</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Update Vehicle Details</h1>

    <form id="updateForm">
      <label for="vehicleNumber">Vehicle Number:</label>
      <input type="text" id="vehicleNumber" name="vehicleNumber" required />
      <button type="button" onclick="searchVehicle()">Search</button>

      <div id="result"></div>

      <label for="newCapacity">New Max Capacity:</label>
      <input type="number" id="newCapacity" name="newCapacity" min="1" />

      <label for="newRoute">New Assigned Route:</label>
      <input type="text" id="newRoute" name="newRoute" />

      <label for="newDriverNIC">New Driver NIC:</label>
      <input type="text" id="newDriverNIC" name="newDriverNIC" />

      <label for="newPassengers">New Assigned Passengers:</label>
      <input
        type="text"
        id="newPassengers"
        name="newPassengers"
        placeholder="Enter passenger names separated by commas"
      />

      <button type="button" onclick="updateVehicle()">
        Update Information
      </button>
    </form>

    <script>
      async function searchVehicle() {
        const vehicleNumber = document.getElementById("vehicleNumber").value;
        const resultContainer = document.getElementById("result");

        const response = await fetch(
          `http://localhost:3001/vehicles/${vehicleNumber}`
        );
        const data = await response.json();

        if (data.error) {
          resultContainer.innerHTML = `<p>${data.error}</p>`;
        } else {
          const {
            vehicleNumber,
            maxCapacity,
            assignedRoute,
            driverNIC,
            assignedPassengers,
          } = data.vehicle;

          const assignedRouteText = assignedRoute
            ? `Assigned Route: ${assignedRoute.join(", ")}`
            : "Assigned Route: N/A";

          const assignedPassengersText = Array.isArray(assignedPassengers)
            ? `Assigned Passengers: ${assignedPassengers.join(", ")}`
            : "Assigned Passengers: N/A";

          resultContainer.innerHTML = `<p>Vehicle Number: ${vehicleNumber}</p>
                                       <p>Current Max Capacity: ${maxCapacity}</p>
                                       <p>${assignedRouteText}</p>
                                       <p>Current Driver NIC: ${driverNIC}</p>
                                       <p>${assignedPassengersText}</p>`;
        }
      }

      async function updateVehicle() {
        const vehicleNumber = document.getElementById("vehicleNumber").value;
        const newCapacity = document.getElementById("newCapacity").value;
        const newRoute = document.getElementById("newRoute").value;
        const newDriverNIC = document.getElementById("newDriverNIC").value;
        const newPassengers = document
          .getElementById("newPassengers")
          .value.split(",")
          .map((passenger) => passenger.trim());

        try {
          const response = await fetch(
            `http://localhost:3001/vehicles/${vehicleNumber}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                newCapacity: newCapacity || undefined,
                newRoute: newRoute || undefined,
                newDriverNIC: newDriverNIC || undefined,
                newPassengers:
                  newPassengers.length > 0 ? newPassengers : undefined,
              }),
            }
          );

          const data = await response.json();

          if (data.error) {
            alert(data.error);
          } else {
            alert(data.message);
          }
        } catch (error) {
          console.error("Error updating vehicle:", error);
          alert(
            "An error occurred while updating the vehicle. Please try again."
          );
        }
      }
    </script>
  </body>
</html>
